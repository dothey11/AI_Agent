<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Financial Chat Assistant â€” Debuggable</title>
<style>
:root{
  --bg:#071027; --panel:#0b1220; --muted:#9aa6b2; --text:#e6f0f6;
  --accent:#00d4ff; --accent2:#ff6b9d; --card:rgba(255,255,255,0.03);
  --border:rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--panel),#071027);color:var(--text);}
.container{max-width:980px;margin:18px auto;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.logo{display:inline-grid;place-items:center;width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#042028;font-weight:700}
.title h1{margin:0;font-size:1.05rem}
.title p{margin:0;color:var(--muted);font-size:0.9rem}
.main{display:flex;gap:16px;padding:16px}
.left{width:300px;background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;border:1px solid var(--border)}
.right{flex:1;display:flex;flex-direction:column;gap:12px}
.chat-window{height:520px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:14px;border-radius:10px;border:1px solid var(--border);display:flex;flex-direction:column}
.messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
.message{max-width:78%;padding:12px;border-radius:12px;line-height:1.4}
.message.user{align-self:flex-end;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px 12px 6px 12px}
.message.bot{align-self:flex-start;background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text)}
.meta{font-size:0.8rem;color:var(--muted);margin-bottom:6px}
.input-area{display:flex;gap:10px;align-items:flex-end;padding-top:8px;border-top:1px solid var(--border)}
.textarea{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);min-height:46px;resize:none}
.btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
.attach{background:var(--card);color:var(--accent)}
.send{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#042028;font-weight:600}
.selected-file{display:none;margin-top:8px;padding:10px;border-radius:8px;background:linear-gradient(90deg,rgba(0,212,255,0.02),rgba(255,107,157,0.02));border:1px solid var(--border);align-items:center;gap:8px}
.selected-file.show{display:flex}
.file-info{flex:1}
.remove{background:transparent;border:none;color:#ff7b7b;cursor:pointer}
.progress{height:8px;background:rgba(255,255,255,0.02);border-radius:8px;overflow:hidden;width:220px}
.progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .12s linear}
.typing{display:flex;align-items:center;gap:8px;color:var(--muted)}
.debug{margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.02);font-size:13px}
.debug pre{max-height:160px;overflow:auto;background:rgba(0,0,0,0.15);padding:8px;border-radius:6px}
.small{font-size:12px;color:var(--muted)}
@media(max-width:860px){.main{flex-direction:column}.left{width:100%}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo">FA</div>
        <div class="title"><h1>Financial Assistant [Dothey AI Agent]</h1><p>Asisten untuk analisa & perencanaan keuangan</p></div>
      </div>
      <div id="status" class="small">Ready</div>
    </div>

    <div class="main">
      <aside class="left">
        <strong>ðŸ‘‹ Selamat datang</strong>
        <p class="small" style="margin-top:8px;color:var(--muted)">Tanyakan atau unggah file Knowledge untuk Agent AI.</p>
        <div style="margin-top:12px"><strong class="small">Contoh:</strong></div>
        <div style="display:grid;gap:8px;margin-top:8px">
          <button class="btn attach" onclick="sendExample('Bagaimana cara memulai investasi untuk pemula?')">ðŸš€ Memulai investasi</button>
          <button class="btn attach" onclick="sendExample('Apa saja jenis investasi jangka panjang?')">ðŸ“ˆ Investasi jangka panjang</button>
          <button class="btn attach" onclick="sendExample('Bagaimana cara diversifikasi portfolio?')">ðŸŽ¯ Diversifikasi</button>
        </div>
      </aside>

      <section class="right">
        <div class="chat-window">
          <div class="messages" id="messages">
            <div class="message bot">
              <div class="meta"><strong>Selamat datang!</strong></div>
              <div class="small" style="color:var(--muted)">Tanyakan apapun atau unggah file Knowledge. UI ini mendeteksi berbagai format respons dari n8n.</div>
            </div>
          </div>

          <div class="input-area">
            <div style="flex:1;display:flex;flex-direction:column">
              <textarea id="input" class="textarea" placeholder="Tulis pertanyaan..." rows="1"></textarea>

              <div class="selected-file" id="selectedFileBox">
                <div style="width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center">ðŸ“Ž</div>
                <div class="file-info">
                  <div id="fn" style="font-weight:600">filename.pdf</div>
                  <div id="fs" class="small" style="color:var(--muted)">123 KB</div>
                </div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
                  <div class="progress" id="progress" style="display:none"><div></div></div>
                  <button class="remove" id="removeFile">âœ–</button>
                </div>
              </div>

              <div class="debug" id="debug" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center"><strong>Debug</strong> <span class="small">(visible saat error)</span></div>
                <div style="margin-top:8px"><strong class="small">Raw response:</strong>
                  <pre id="rawResp"></pre>
                </div>
                <div style="margin-top:8px"><strong class="small">Parsed JSON:</strong>
                  <pre id="parsedJson"></pre>
                </div>
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px">
              <input id="file" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.png,.jpg,.jpeg" style="display:none" />
              <button class="btn attach" id="attachBtn">ðŸ“Ž Attach</button>
              <button class="btn send" id="sendBtn">Send</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
/* CONFIG: ganti ke webhook n8n Anda */
const API_URL = "https://gentleman-consortium-lance-photos.trycloudflare.com/webhook/dothey_agent";

/* UI refs */
const inputEl = document.getElementById('input');
const fileEl = document.getElementById('file');
const attachBtn = document.getElementById('attachBtn');
const sendBtn = document.getElementById('sendBtn');
const messagesEl = document.getElementById('messages');
const selectedBox = document.getElementById('selectedFileBox');
const fnEl = document.getElementById('fn');
const fsEl = document.getElementById('fs');
const removeFileBtn = document.getElementById('removeFile');
const progressEl = document.getElementById('progress');
const progressFill = progressEl.querySelector('div');
const statusEl = document.getElementById('status');
const debugPanel = document.getElementById('debug');
const rawRespEl = document.getElementById('rawResp');
const parsedJsonEl = document.getElementById('parsedJson');

let selectedFile = null;
let sessionId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('sid_'+Math.random().toString(36).slice(2,9));

/* Helpers */
function appendMessage(text, sender='bot'){
  const wrap = document.createElement('div');
  wrap.className = 'message ' + (sender==='user' ? 'user' : 'bot');
  const meta = document.createElement('div'); meta.className='meta';
  meta.textContent = sender==='user' ? 'You' : 'Assistant';
  const body = document.createElement('div');
  body.innerHTML = sender==='bot' ? marked.parse(text) : escapeHtml(text);
  wrap.appendChild(meta); wrap.appendChild(body);
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
function setProgress(p){ progressFill.style.width = Math.max(0,Math.min(100,p))+'%'; }

/* Smart extractor: tries many shapes that n8n might return */
function extractAnswer(obj){
  if(obj == null) return null;
  // direct keys to try
  const keys = ['answer','Answer','ai_reply','AIResponse','message','reply','output','Output','result','Result','data'];
  for(const k of keys){
    if(typeof obj[k] === 'string' && obj[k].trim().length) return obj[k];
    if(Array.isArray(obj[k]) && obj[k].length){
      // if array of strings
      if(typeof obj[k][0] === 'string') return obj[k][0];
      // if array contains n8n item shape { json: {...} }
      const first = obj[k][0];
      if(first && typeof first === 'object'){
        // try nested
        for(const sub of keys){
          if(first.json && typeof first.json[sub] === 'string') return first.json[sub];
          if(typeof first[sub] === 'string') return first[sub];
        }
      }
    }
    if(typeof obj[k] === 'object' && obj[k] !== null){
      // if nested object: try nested keys
      for(const sub of keys){
        if(typeof obj[k][sub] === 'string') return obj[k][sub];
      }
    }
  }

  // fallback: breadth-first search for the first long-ish string value (likely the answer)
  const queue = [obj];
  while(queue.length){
    const node = queue.shift();
    if(typeof node === 'string'){
      if(node.trim().length > 10) return node;
    } else if(Array.isArray(node)){
      for(const it of node) queue.push(it);
    } else if(typeof node === 'object' && node !== null){
      for(const p in node){
        if(typeof node[p] === 'string' && node[p].trim().length>10) return node[p];
        else queue.push(node[p]);
      }
    }
  }
  return null;
}

/* Event handlers */
attachBtn.addEventListener('click', ()=> fileEl.click());
fileEl.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.size > 20 * 1024 * 1024){ alert('File max 20MB'); fileEl.value=''; return; }
  selectedFile = f;
  fnEl.textContent = f.name;
  fsEl.textContent = (f.size/1024).toFixed(1)+' KB';
  selectedBox.classList.add('show');
});
removeFileBtn.addEventListener('click', ()=>{ selectedFile=null; fileEl.value=''; selectedBox.classList.remove('show'); progressEl.style.display='none'; setProgress(0); });

inputEl.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); triggerSend(); }
});
sendBtn.addEventListener('click', triggerSend);

function sendExample(q){ inputEl.value=q; triggerSend(); }

/* Main send logic: JSON when no file, FormData via XHR when file present (progress) */
async function triggerSend(){
  const text = inputEl.value.trim();
  if(!text && !selectedFile) return;
  appendMessage(text || '(file)', 'user');
  inputEl.value='';
  statusEl.textContent='Sending...';
  debugPanel.style.display='none';
  rawRespEl.textContent=''; parsedJsonEl.textContent='';

  if(selectedFile){
    // XHR with FormData to support upload progress
    const fd = new FormData();
    fd.append('chatInput', text || '');
    fd.append('session_id', sessionId);
    fd.append('timestamp', new Date().toISOString());
    fd.append('meta', JSON.stringify({source:'web'}));
    fd.append('attachment', selectedFile, selectedFile.name);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', API_URL, true);
    xhr.timeout = 120000;

    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable){ progressEl.style.display='block'; setProgress(Math.round((e.loaded/e.total)*100)); }
    };
    xhr.onload = ()=>{
      progressEl.style.display='none'; setProgress(0); statusEl.textContent='Ready';
      const raw = xhr.responseText;
      console.log('raw response:', raw, 'status:', xhr.status);
      handleRawResponse(raw, xhr.status);
    };
    xhr.onerror = ()=>{
      statusEl.textContent='Network error';
      appendMessage('(network error)', 'bot');
      debugPanel.style.display='block';
      rawRespEl.textContent='(network error - request failed)';
    };
    xhr.ontimeout = ()=>{
      statusEl.textContent='Timeout';
      appendMessage('(request timeout)', 'bot');
      debugPanel.style.display='block';
      rawRespEl.textContent='(timeout)';
    };
    try { xhr.send(fd);} catch(e){ console.error(e); appendMessage('(send error)', 'bot'); statusEl.textContent='Error'; }
  } else {
    // No file: use fetch JSON
    const payload = { chatInput: text || '', session_id: sessionId, timestamp: new Date().toISOString(), meta:{source:'web'} };
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        credentials: 'omit',
      });
      const raw = await res.text();
      console.log('raw response:', raw, 'status:', res.status, 'ctype:', res.headers.get('content-type'));
      statusEl.textContent = res.ok ? 'Ready' : `HTTP ${res.status}`;
      handleRawResponse(raw, res.status);
    } catch(err){
      console.error('fetch error', err);
      statusEl.textContent='Network error';
      appendMessage('(network error)', 'bot');
      debugPanel.style.display='block';
      rawRespEl.textContent = String(err);
    }
  }
}

/* Parse raw response & append message or show debug */
function handleRawResponse(rawText, status){
  if(!rawText || rawText.trim().length===0){
    appendMessage('(no response)', 'bot');
    debugPanel.style.display='block';
    rawRespEl.textContent = '(empty response)'; parsedJsonEl.textContent = '';
    return;
  }

  rawRespEl.textContent = rawText;
  let parsed = null;
  try {
    parsed = JSON.parse(rawText);
    parsedJsonEl.textContent = JSON.stringify(parsed, null, 2);
  } catch(e){
    // not JSON â€” show raw only
    parsedJsonEl.textContent = '(not JSON)';
    console.warn('parse error', e);
  }

  // Try to extract answer
  const answer = extractAnswer(parsed) || extractAnswer(window.tryWrapJson(rawText));
  if(answer){
    appendMessage(answer, 'bot');
    debugPanel.style.display='none';
  } else {
    // no answer found
    appendMessage('(no response)', 'bot');
    debugPanel.style.display='block';
  }
}

/* small helper to attempt parse if raw contains JSON-ish text inside */
window.tryWrapJson = (raw)=>{
  try {
    return JSON.parse(raw);
  } catch(e){
    // try to find first { ... } in string
    const m = raw.match(/\{[\s\S]*\}/m);
    if(m) try { return JSON.parse(m[0]); } catch(e2){}
  }
  return null;
};

/* On load focus */
window.addEventListener('load', ()=> inputEl.focus());

</script>
</body>
</html>
